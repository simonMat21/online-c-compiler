<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>C Compiler API Demo</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #2c3e50;
        color: #333;
        margin: 0;
        height: 150vh;
        display: flex;
        flex-direction: column;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #2c3e50;
        color: white;
        padding: 10px 20px;
        border-radius: 0 0 12px 12px;
      }

      header h1 {
        margin: 0;
        text-align: left;
      }

      header button {
        padding: 8px 16px;
        font-size: 14px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      header button:hover {
        background-color: #2980b9;
      }

      main {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      #resizable-wrapper {
        display: flex;
        width: 100%;
      }

      #editor-container {
        min-width: 300px;
        width: 50%;
        overflow: auto;
        border-right: 2px solid #ccc;
        display: flex;
        flex-direction: column;
        border-radius: 12px 0 0 12px;
        background: white;
      }

      #editor-label {
        background: #ecf0f1;
        padding: 10px;
        font-weight: bold;
        text-align: left;
        border-radius: 12px 0 0 0;
      }

      #editor {
        flex: 1;
        height: 100%;
      }

      #resizer {
        width: 8px;
        background-color: #ccc;
        cursor: ew-resize;
      }

      #side-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 300px;
        overflow: auto;
        border-radius: 0 12px 12px 0;
        background: white;
      }

      #tabs {
        display: flex;
        background-color: #ecf0f1;
        border-bottom: 1px solid #ccc;
        border-radius: 0 12px 0 0;
      }

      #tabs button {
        flex: 1;
        padding: 10px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: bold;
        text-align: left;
      }

      #tabs button.active {
        background-color: white;
        border-bottom: 2px solid #3498db;
        color: #3498db;
      }

      #test-cases-section,
      #output-section {
        display: none;
        padding: 15px;
        height: 100%;
        overflow-y: auto;
      }

      #test-cases-section.active,
      #output-section.active {
        display: block;
      }

      #test-cases > div {
        margin-bottom: 20px;
        padding-left: 20px;
        position: relative;
        border-radius: 8px;
        background: #fff;
        padding: 10px;
        display: flex;
        flex-direction: column;
        border: 1px solid #ccc;
      }

      #test-cases > div::before {
        content: "";
        position: absolute;
        top: 16px;
        left: 5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #ccc;
      }

      #test-cases > div.passed::before {
        background-color: #2ecc71;
      }

      #test-cases > div.failed::before {
        background-color: #e74c3c;
      }

      textarea {
        font-family: monospace;
        font-size: 14px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        resize: vertical;
        width: 100%;
        background-color: #fff;
        margin-bottom: 10px;
      }

      .test-case-label {
        font-weight: bold;
        margin-left: 20px;
        margin-bottom: 5px;
        text-align: left;
      }

      #output {
        white-space: pre-wrap;
        font-family: monospace;
        background-color: #1e1e1e;
        color: #00ff00;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }

      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        display: none;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        z-index: 999;
      }

      .result-passed {
        color: #2ecc71;
      }

      .result-failed {
        color: #e74c3c;
      }
    </style>
  </head>

  <body>
    <div id="loading-overlay">⏳ Compiling your code...</div>
    <header>
      <h1>C Compiler API Demo</h1>
      <div>
        <button onclick="addTestCase()">➕ Add Test Case</button>
        <button onclick="compileCode()">▶ Run Code</button>
      </div>
    </header>

    <main>
      <div id="resizable-wrapper">
        <div id="editor-container">
          <div id="editor-label">Editor</div>
          <div id="editor"></div>
        </div>
        <div id="resizer"></div>
        <div id="side-panel">
          <div id="tabs">
            <button onclick="switchTab('test-cases-section')" class="active">
              Test Cases
            </button>
            <button onclick="switchTab('output-section')">Output</button>
          </div>

          <div id="test-cases-section" class="active">
            <div id="test-cases"></div>
          </div>

          <div id="output-section">
            <label>
              <input type="checkbox" id="subscribeCheckbox" />
              should output include input value
            </label>
            <pre id="output">Output will appear here...</pre>
          </div>
        </div>
      </div>
    </main>

    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script>
      require.config({
        paths: { vs: "https://unpkg.com/monaco-editor@0.45.0/min/vs" },
      });
      require(["vs/editor/editor.main"], function () {
        window.editor = monaco.editor.create(
          document.getElementById("editor"),
          {
            value: `#include <stdio.h>\nint main() {\n    char name[20];\n    scanf("%s", name);\n    printf("Hello %s, ready to code in C??\\n", name);\n    return 0;\n}`,
            language: "c",
            theme: "vs-dark",
            fontSize: 14,
            automaticLayout: true,
          }
        );
      });
    </script>

    <script>
      async function GetVales() {
        const response = await fetch("/api/backend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({}),
        });

        const result = await response.json();
        alert(result.keyUsed);
      }

      function switchTab(id) {
        document
          .querySelectorAll("#tabs button")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll("#side-panel > div")
          .forEach((div) => div.classList.remove("active"));
        document.querySelector(`#${id}`).classList.add("active");
        document
          .querySelector(`#tabs button[onclick*="${id}"]`)
          .classList.add("active");
      }

      function addTestCase(input = "", expected = "") {
        const container = document.getElementById("test-cases");
        const div = document.createElement("div");
        const testCaseCount = container.children.length + 1;
        div.innerHTML = `
                <div class="test-case-label">Test Case ${testCaseCount}</div>
                <textarea placeholder="Input">${input}</textarea>
                <textarea placeholder="Expected Output">${expected}</textarea>
              `;
        container.appendChild(div);
      }

      function getTestCases() {
        const divs = Array.from(document.getElementById("test-cases").children);
        return divs.map((div) => {
          const [label, inputArea, expectedArea] = div.querySelectorAll(
            ".test-case-label, textarea"
          );
          return {
            input: inputArea.value.trim(),
            expected: expectedArea.value.trim(),
            element: div,
          };
        });
      }

      function addPrintfAfterScanf(code) {
        const lines = code.split("\n");
        const updatedLines = [];

        const scanfRegex = /scanf\s*\(\s*"([^"]+)"\s*,\s*([^)]+)\)/;

        for (let i = 0; i < lines.length; i++) {
          updatedLines.push(lines[i]);

          const match = lines[i].match(scanfRegex);
          if (match) {
            const formatString = match[1]; // e.g., "%d %f %s"
            const args = match[2] // e.g., "&x, &y, name"
              .split(",")
              .map((arg) => arg.trim().replace(/^&/, "")); // remove leading &

            const specifiers = [...formatString.matchAll(/%[a-zA-Z]/g)].map(
              (m) => m[0]
            );

            if (args.length === specifiers.length) {
              const printfFormat =
                specifiers
                  .map((spec) => {
                    if (spec === "%c") return "%c";
                    if (spec === "%s") return "%s";
                    if (spec === "%f" || spec === "%lf") return "%f";
                    return "%d"; // default fallback for %d, %u, %ld, etc.
                  })
                  .join(" ") + "\\n";

              const printfLine = `printf("${printfFormat}", ${args.join(
                ", "
              )});`;
              updatedLines.push(printfLine);
            } else {
              updatedLines.push(
                "// ⚠️ Could not auto-generate printf due to format mismatch"
              );
            }
          }
        }

        return updatedLines.join("\n");
      }

      let q = false;
      document
        .getElementById("subscribeCheckbox")
        .addEventListener("change", function () {
          if (this.checked) {
            q = false;
          } else {
            q = true;
          }
        });

      async function compileCode() {
        const code = document.getElementById("subscribeCheckbox").checked
          ? addPrintfAfterScanf(editor.getValue())
          : editor.getValue();

        const testCases = getTestCases();

        document.getElementById("loading-overlay").style.display = "flex";
        const response = await fetch("/api/backend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code, testCases }),
        });

        const result = await response.json();
        const finalOutput = result.output || result.error || "No output";
        const resultList = result.resultList || result.error || "No output";

        for (let i = 0; i < testCases.length; i++) {
          const { input, expected, element } = testCases[i];
          const passed = resultList[i];
          element.classList.remove("passed", "failed");
          element.classList.add(passed ? "passed" : "failed");
        }

        document.getElementById("output").innerHTML = finalOutput;
        switchTab("output-section");
        document.getElementById("loading-overlay").style.display = "none";
      }

      window.onload = () => {
        addTestCase("Alice", "Hello Alice, ready to code in C??");

        const resizer = document.getElementById("resizer");
        const editorContainer = document.getElementById("editor-container");

        let isResizing = false;

        resizer.addEventListener("mousedown", (e) => {
          isResizing = true;
          document.body.style.cursor = "ew-resize";
        });

        window.addEventListener("mousemove", (e) => {
          if (!isResizing) return;
          const newWidth = e.clientX;
          editorContainer.style.width = newWidth + "px";
        });

        window.addEventListener("mouseup", () => {
          isResizing = false;
          document.body.style.cursor = "default";
        });
      };
    </script>
    <footer
      style="
        background-color: #2c3e50;
        color: white;
        text-align: center;
        padding: 15px 20px;
        border-radius: 12px 12px 0 0;
        font-size: 14px;
        height: 100px;
      "
    >
      <div>
        Built by <strong>Justaguy.21</strong> •
        <a
          href="https://docs.google.com/forms/d/e/1FAIpQLSczoB5belTBxoNnV5wXVXfHkgwBhhRTLvfPqzBul1TwdpH61A/viewform?usp=dialog"
          style="color: #3498db; text-decoration: none"
          >Report an Issue</a
        >
      </div>
    </footer>
  </body>
</html>
